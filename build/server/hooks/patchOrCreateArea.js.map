{
  "version": 3,
  "sources": ["../../../src/server/hooks/patchOrCreateArea.ts"],
  "sourcesContent": ["import { Feature, featureCollection, LineString, Point } from \"@turf/helpers\";\nimport pointsWithinPolygon from \"@turf/points-within-polygon\";\nimport { determineTrapTypes } from \"../../lib/atudo/determineTrapTypes\";\n// import { traps } from \"../../lib/atudo/traps\";\nimport { Scheduler } from \"../../lib/Scheduler\";\n\nimport type { Hook, HookContext } from \"@feathersjs/feathers\";\nimport { trapsChain } from \"./trapsChain\";\nimport { feature, featureReduce } from \"@turf/turf\";\nimport polyline from \"@mapbox/polyline\";\nimport getPoiPolyPointsAsync, { AnalyzedType } from \"../../lib/getPoiPolyPointsAsync\";\n\nconst patchOrCreateArea = (): Hook => {\n\treturn async (context: HookContext<radarTrap.Area>) => {\n\t\tconst startTime = performance.now();\n\t\tconst { data, service, params } = context;\n\t\tconst { _id } = data!;\n\n\t\tdata!.timestamp = new Date().toString();\n\n\t\tScheduler.pause(_id);\n\t\tservice.emit(\"status\", { _id: data!._id, status: \"loading\" });\n\n\t\tconst [record] = (await service.find({\n\t\t\tquery: { _id, $select: [\"areaTraps\", \"polysFeatureCollection\"] },\n\t\t\tpaginate: false,\n\t\t})) as Partial<radarTrap.Areas>;\n\n\t\tif (params.patchSourceFromClient || params.patchSourceFromServer) {\n\t\t\tconst areaPolygon = Object.values(data!.areaPolygons!)[0];\n\n\t\t\tlet { resultPoiPoints, resultPolyPoints } = await getPoiPolyPointsAsync(areaPolygon, AnalyzedType.POLYGONE);\n\n\t\t\tresultPolyPoints = pointsWithinPolygon(featureCollection(resultPolyPoints), areaPolygon).features;\n\t\t\tconsole.log(\"resultPolyPoints >>>\", resultPolyPoints.length);\n\n\t\t\tlet resultPolys: Feature<Point | LineString, radarTrap.Poly>[] = [];\n\t\t\tresultPolys = featureReduce(\n\t\t\t\tfeatureCollection(resultPolyPoints),\n\t\t\t\t(features: Feature<Point | LineString, radarTrap.Poly>[], currentFeature) => {\n\t\t\t\t\tif (currentFeature.properties.type === \"closure\") {\n\t\t\t\t\t\tfeatures.push(currentFeature);\n\n\t\t\t\t\t\tif (currentFeature.properties.polyline !== \"\") {\n\t\t\t\t\t\t\tfeatures.push(\n\t\t\t\t\t\t\t\tfeature<LineString, radarTrap.Poly>(\n\t\t\t\t\t\t\t\t\tpolyline.toGeoJSON(currentFeature.properties.polyline as string),\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t...currentFeature.properties,\n\t\t\t\t\t\t\t\t\t\ttype: \"120\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (currentFeature.properties.type === \"20\") {\n\t\t\t\t\t\tif (currentFeature.properties.polyline !== \"\") {\n\t\t\t\t\t\t\tfeatures.push(\n\t\t\t\t\t\t\t\tfeature<LineString, radarTrap.Poly>(\n\t\t\t\t\t\t\t\t\tpolyline.toGeoJSON(currentFeature.properties.polyline as string),\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t...currentFeature.properties,\n\t\t\t\t\t\t\t\t\t\ttype: \"120\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn features;\n\t\t\t\t},\n\t\t\t\t[],\n\t\t\t);\n\n\t\t\tconst { traps: allPolys } = trapsChain<radarTrap.Poly>(\n\t\t\t\t{ allPolys: record?.polysFeatureCollection?.features || [] },\n\t\t\t\t{ allPolys: resultPolys },\n\t\t\t);\n\t\t\tdata!.polysFeatureCollection = featureCollection(allPolys.allPolys);\n\n\t\t\tresultPoiPoints = pointsWithinPolygon(featureCollection(resultPoiPoints), areaPolygon).features;\n\t\t\tconsole.log(\"resultPoiPoints >>>\", resultPoiPoints.length);\n\n\t\t\tconst resultTypeTraps = determineTrapTypes(resultPoiPoints);\n\t\t\tconst {\n\t\t\t\ttraps: areaTraps,\n\t\t\t\tnewTrapsReduced,\n\t\t\t\trejectedTrapsReduced,\n\t\t\t} = trapsChain(record?.areaTraps, resultTypeTraps);\n\n\t\t\tdata!.areaTraps = areaTraps;\n\t\t\tdata!.areaTrapsNew = newTrapsReduced;\n\t\t\tdata!.areaTrapsRejected = rejectedTrapsReduced;\n\t\t\t// data!.areaTrapsNew = newTraps;\n\t\t\t// data!.areaTrapsEstablished = establishedTraps;\n\t\t\t// data!.areaTrapsRejected = rejectedTraps;\n\t\t}\n\n\t\tif (record !== undefined) {\n\t\t\tcontext.result = await service.patch(_id, data as Partial<radarTrap.Area>, {\n\t\t\t\t...params,\n\t\t\t\tpublishEvent: false,\n\t\t\t});\n\t\t}\n\n\t\tconst endTime = performance.now();\n\t\tconsole.log(`patchOrCreateArea2() dauerte: ${(endTime - startTime) / 1_000} Sekunden`);\n\n\t\treturn context;\n\t};\n};\n\nexport { patchOrCreateArea };\n"],
  "mappings": "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",
  "names": ["getPoiPolyPointsAsync", "pointsWithinPolygon", "polyline"]
}
